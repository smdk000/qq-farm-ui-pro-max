# QQ 农场智能助手 - 开发交接文档

**项目名称**：QQ 农场智能助手（qq-farm-bot-ui-main）
**交接日期**：2026-03-02
**当前版本**：v3.8.0
**交接状态**：核心重构完成，进入稳定测试期

---

## 一、项目概述

基于 Node.js 的 QQ 农场自动化挂机工具，支持多账号管理、Web 控制面板、实时日志与数据分析。

| 维度 | 内容 |
|------|------|
| **后端** | Node.js 22+ / Express 4 / Socket.io 4 / MySQL 8.0 操作池 / Redis |
| **前端** | Vue 3.5 / Vite / TypeScript / Pinia / UnoCSS |
| **部署** | Docker Compose / pnpm workspace / GitHub Actions |
| **数据库** | MySQL (无缝防死锁) + Redis (分布式高频缓存) |
| **协议** | Protobuf（腾讯 QQ 农场私有协议） |

---

## 二、近期已完成工作

### 2.1 核心功能交付 (v3.0.0 - v3.8.0)

| 版/时间 | 功能里程碑 | 状态 |
|------|------|------|
| v3.0.0 | 体验卡系统（自助领卡/续费/管理/防刷） | ✅ |
| v3.2.7 | 自动同意好友申请 + 60秒极限防偷抢收 | ✅ |
| v3.4.0 | 偷菜管理图形化拆分 + Diff高亮改动二次核对弹窗 | ✅ |
| v3.6.0 | 端云同步时间戳仲裁防伪墙（多端无损状态同步） + 渲染切片提升首屏速度 | ✅ |
| v3.7.0 | “蹲守偷菜”精准打击与延迟挂载，智能感知好友作物成熟倒计时 | ✅ |
| v3.8.0 | **终局迁移**：SQLite 平滑移除，MySQL/Redis 强隔离与全异步闭环接管 | ✅ |
| v3.8.1 | **扫码鉴权重构**：修复数据分离引起的400断连及第三方扫码乱码/黑化视觉碰撞 | ✅ |

### 2.2 数据库终局迁移 (Phase 1 成功) 

为提升现有架构的承载力至上千账号，我们彻底告别了脆弱的 SQLite，并完成了以下核心建设：

1. **[NEW] `mysql-db.js` 与 `redis-cache.js` 驱动并网**
   - 彻底移除了 `better-sqlite3` 与臃肿僵硬的 `store.json / accounts.json` 同步读取。
   - 所有数据库调用转为基于 `Promise` 极速并行协程。
2. **`auth_data` 数据源隔离屏障与修复**
   - 将遗留下来的 `token`/`psKey` 等扫码环境密文打包封装至 MySQL `accounts` 表的 `auth_data` JSON 行级数据。
   - 彻底修复了异步重写导致的 `TypeError` 崩溃与 QQ 农场 `[WS] 400` 鉴权丢失（通过 `getAccountFull` 二次注入闭环保障）。
3. **数据级别越权阻断 (Role & Promise 修复)**
   - API 与 WS 分发队列全部附加上了严格的 `currentUser` 与 `await resolveAccId()` 双保险所有权过滤。

> [!WARNING]
> **Phase 1 验证要求（已执行）：**
> 已验证扫码登录全链路正常写入 MySQL ，Worker 挂载凭据后自动登录启动 WebSocket，不会因请求污染卡死。

---

## 三、未完成 / 待推进的工作计划

### 3.1 架构提升延伸 (Phase 2 ~ 3)

我们已经协商拟定了一份大型数据库演进计划：`implementation_plan.md.resolved`。
*   **Phase 2**: 在前端控制面板建立一套直观可视化的 MySQL / Redis 服务性能监控看板。将遗留的简单状态存储移交给 Redis Pub/Sub。
*   **Phase 3**: 部署多进程（PM2 Cluster）分治，冲刺 5000+ 乃至万级账号。

### 3.2 待执行产品方案 (计划已确认)

项目中已存在如下 HTML 平面演示计划文件，等待排期执行功能侧写入：
*   `Plan_20260301_项目根目录整理与归档.html`: 回收无用与乱象代码、净化工程结构。
*   `Plan_20260301_云端同步与通知.html`: 建立右下角/顶部铃铛的通知中心和云端系统偏好缓存。

---

## 四、关键文件地图导览

当你再度接手 / 回到这套系统时，请查阅这些高权态的控制中心：

**1. 后端总控 API (`core/src/controllers/admin.js`)**
所有 Web 端控制面板请求汇聚中心。目前过于臃肿(1300 行+)，规划中需将其打散隔离为独立的 Routers (如 `auth.js` / `settings.js` / `dash.js` ...)。

**2. 数据流持仓 (`core/src/models/store.js` & `user-store.js`)**
你关注的后台一切状态、主题、定时配置都在这里。Phase 0 拆分了庞然大物的 Account 阵列，降低了文件 I/O 的阻塞。

**3. 时序网关 (`core/src/utils/network.js`)**
这里是心血之作，里面包含 WebSocket 链路、紧急排队插入 (Urgent Push) 和防挂死的 3QPS `Token Bucket` 硬件限速池。切勿随意调大。

**4. 执行逻辑流 (`core/src/services/farm.js` & `friend.js`)**
挂机代理本体，控制了农田监控、化肥分配、60 秒抢收以及偷、捣乱的核心算法轮询。

---

## 五、如何恢复推进？

下次唤醒开发状态时，可直接发送：

> "请读取并了解 `docs/开发交接文档_20260302.md`，目前我们希望从哪一项工作（例如：测试修复 Phase 0 / 解决微信扫码）继续展开？"

> [!TIP]
> 记得检查一下你的 MySQL 并把 `farm-bot.db` 和 `store.json` 做一次安全 Backup 备份。
