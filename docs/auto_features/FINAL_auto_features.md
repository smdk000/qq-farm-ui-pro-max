# 核心自动化功能审查与优化建议 (FINAL_auto_features.md)

## 1. 核心功能安全与稳定性审查

在最近新增的“自动同意好友”以及“60秒防偷施肥”两大核心功能中，代码逻辑已通过编译并正常注入系统事件流。经过对执行代码的重新盘查，总结以下几点**可能带来的潜在影响**及应对现状。

### 1.1 `60秒防偷机制` 的影响与边缘情况分析
- **表现与机制**: 当前版本将倒计时任务驻留在内存队列中（`farmScheduler.setTimeoutTask`）。若检测到距离 10 分钟以内的植物，则创建一个 “剩余 60 秒触发唤醒” 的闭包。
- **潜在问题 (Race Condition)**: 
  - 如果用户在植物恰好还剩 2 分钟时**手动点击了普通化肥**并触发成熟且收获，但内存中的定时器（`anti_steal_land_x`）**并未被撤销**。
  - 当原定时间到达时，定时器依然会唤醒并对该土地（`landId`）尝试施加化肥。若此时该土地已经被种上了新的种子（且生长时间极长），定时器会盲目对这颗新种子施肥，导致**化肥被意外浪费**一次。
- **当前防御**: 施肥 API 只有在土地为实体存在且不是死草、空地时才生效。但这依然无法防范“新苗复种”带来的化肥被消耗。

### 1.2 `自动同意好友` 的影响分析
- **表现与机制**: 我们双管齐下：基于 WebSockets 推送的事件侦听 `friendApplicationReceived` 做到实时通过，并利用 `friendCheckLoop` 每 10 分钟拉取一次接口兜底容错。
- **潜在问题**:
  - `friendCheckLoop` 会频繁请求 QQ 互联申请状态接口。如果腾讯有严苛的请求频控策略（Rate Limit），可能导致该拉取接口出现 `400/403` 被拦截甚至小黑屋警告。
- **当前防御**: 轮询逻辑依赖系统的 `CONFIG.friendCheckInterval`（通常为10分钟左右），暂时处于较为低频的安全水位。

---

## 2. 下一步优化建议方向 (Optimization Roadmap)

针对上述问题，提供以下改进与建议（可留入后续 Todo）：

1. **为 `antiStealHarvest` 加装二次校验墙 (Double Check Checkpoint)**
   > 推荐在 `farm.js` 的 `antiStealHarvest` 被唤醒的第一行，先偷偷拉取 `getAllLands()` 或从缓存中核对一下当前地块的 `matureInSec` 是否处于 `(<65s 且 >0)` 的合理区间，并且确认为“生长中（growing）”状态。如果不满足，立刻静默抛弃执行，避免浪费化肥。

2. **化肥库存拦截检测**
   > 目前系统依靠腾讯接口返回失败（无化肥）来进行代码降级。后续可维护一个轻量级的背包缓存，发现 `NORMAL_FERTILIZER_ID` 库存为 0 时，连 API 都不发直接跳过防偷触发机制。

3. **同意好友的频率阈值降载**
   > 由于 `onFriendApplicationReceived` 的推送已经极其准确。可以考虑降低主动轮询圈 `checkAndAcceptApplications()` 的调用频率，例如改为“好友巡查每 5 次（约50分钟）”再发起主动对账，将网络请求压力尽量让渡给被动推送。

## 3. 总体结论

**功能已通过技术审查并具备准上线质量**。
虽然存在一些极端情景（例如用户手动提前秒收引发定时器空转），但由于游戏接口自带严密校验，因此不会造成脚本崩溃，最多只是意外浪费 1 颗肥料，属于“极小概率的非致命副作用”。
在后续重构版本中，可采纳上述加入双重校验 (Double-Check) 的建议使代码达到绝对完美。
