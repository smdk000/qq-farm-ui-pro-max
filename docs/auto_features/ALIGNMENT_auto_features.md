# ALIGNMENT: 自动同意好友与60秒施肥（防偷）功能

## 1. 现状分析
根据对当前项目代码库（前端 `web` 与 后端 `core`）的分析与比对：

1. **自动同意好友 (Auto Accept Friends)**
   - **后端状态：** `core/src/services/friend.js` 中已经定义了底层的协议接口 `getApplications`（获取好友申请列表）和 `acceptFriends`（同意好友申请），但是缺乏定时/轮询调用这些接口的自动化业务逻辑。
   - **前端状态：** `Settings.vue` 及对应的数据模型中并没有“自动同意好友”的开关。

2. **60秒施肥(防偷) (60s Anti-steal Fertilize)**
   - **后端状态：** 现有的 `runFertilizerByConfig` 和 `fertilize` 逻辑，主要是在作物刚种植或巡田时，立即计算并投入化肥以尽可能缩短生长周期。但代码中**没有**“在成熟前第60秒精准施肥并立即收获”的防偷防截胡逻辑。
   - **前端状态：** `Settings.vue` 中仅有常规的施肥策略配置（普通化肥、有机化肥等），没有“60秒施肥(防偷)”的开关配置。

**结论：** 我们的程序**目前不具备**这两个自动化功能。

## 2. 需求拆解与对齐

### 2.1 自动同意好友
- **目标：** 定期检查好友申请列表，自动通过所有请求。
- **配置项：** 需要在账号配置自动化面板（`Settings.vue`）中新增一个 `friend_auto_accept` 布尔值开关。
- **执行时机：** 可以在好友巡查循环（`friendLoop`）或一个独立的定时调度任务中执行。为了不影响正常的偷菜/帮忙逻辑，应当将它无缝介入现有的轮询流中，且要考虑接口调用频率（不宜过频，例如每若干分钟检查一次即可）。

### 2.2 60秒施肥(防偷)
- **目标：** 在作物即将成熟的最后一分钟（60秒内），自动使用化肥使其瞬间成熟，然后立即执行收获，完全不给其他玩家任何偷菜的时间窗口。
- **配置项：** 需要在 `Settings.vue` 中新增一个 `fertilizer_60s_anti_steal` 布尔值开关。
- **执行逻辑：**
  - 在 `getLandsDetail` 分析每块土地时，如果作物处于发芽至结果（未成熟）的阶段，且距离成熟时间 `matureInSec` 大于某个时间阈值（如大于 65 秒），则通过调度器 `farmScheduler.schedule('antiSteal_landId', targetTime)` 预约在未来距离成熟刚好剩 60 秒的时候唤醒。
  - 唤醒后，直接对其施放一次普通化肥（或能缩减一小时以上时间的肥料），服务端会判定该作物瞬间成熟。
  - 施肥成功后，立即调用 `harvest` 接口将该作物全量收入仓库。
  - 需要在后端 `store.js` 进行配置持久化。

## 3. 潜在的边界情况与确认项 (供开发者自检)
- **肥料库存不足：** 60秒施肥时，如果背包里没有任何化肥怎么办？答：应优雅降级为正常等待 60 秒后普通收获。
- **接口防重并发：** 需要保证同一块土地不会被多次触发防偷施肥。通过 `landId` 粒度的定时器锁或者状态机来保证。
- **新功能与原有功能的相容性：** 若开启了这两种功能，是否与现有的 `fertilizer: 'both'` 等常态施肥冲突？答：常态施肥一般在刚种植时完成，若剩余时间仍然较长，60秒施肥相当于在最后阶段进行收尾。应当设计两者兼容。

---
*进入下一步：CONSENSUS 共识达成与计划输出*
