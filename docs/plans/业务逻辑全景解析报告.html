<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQ Farm Bot 2.1 - 业务逻辑与全景架构解析报告</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --text-color: #c9d1d9;
            --title-color: #58a6ff;
            --border-color: #30363d;
            --accent-color: #2ea043;
            --warning-color: #d29922;
            --danger-color: #f85149;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 40px;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        h1, h2, h3, h4 {
            color: var(--title-color);
            margin-top: 1.5em;
        }
        h1 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            text-align: center;
        }
        h2 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        .card {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        ul, ol {
            padding-left: 20px;
        }
        li {
            margin-bottom: 8px;
        }
        .tag {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 6px;
            background: var(--border-color);
        }
        .tag.success { background: var(--accent-color); color: #fff; }
        .tag.warning { background: var(--warning-color); color: #111; }
        .tag.danger { background: var(--danger-color); color: #fff; }
        .mermaid {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 10px 14px;
            text-align: left;
        }
        th {
            background-color: #21262d;
            font-weight: bold;
        }
    </style>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    </script>
</head>
<body>

<div class="container">
    <h1>QQ Farm Bot 2.1 业务逻辑全景解析报告</h1>
    
    <div class="card">
        <h2>1. 项目宏观概述 <span class="tag success">Pnpm Workspace</span> <span class="tag">Node.js + Vue 3</span></h2>
        <p>本项目经历由 1.0 版本（含 AI 的多用户 SaaS 平台）向 <strong>2.1 版本（单用户高性能自用版农场自动化工具）</strong>的重构跃迁。在 2.1 版本中彻底剥离了复杂的用户计费与多租户权限系统，并采用 <code>pnpm workspace</code> 实现了 <code>core</code> (核心引擎) 与 <code>web</code> (前端面板) 的彻底解耦解耦。</p>
        <p><strong>核心业务定位：</strong>全自动化、防泄漏、零人工干预的 QQ 农场挂机流水线，支持多账号登录与并发任务调度。</p>
    </div>

    <div class="card">
        <h2>2. 系统架构拓扑图</h2>
        <div class="mermaid">
        graph TD;
            Client[Web浏览器客户端] -->|HTTP REST API| API[Admin / API 控制器]
            Client -->|WebSocket| WS[Socket.IO 实时通信]
            
            API --> Engine[Runtime Engine 运行层]
            WS --> Engine
            
            subgraph Backend [Node.js Core Backend Engine]
                Engine --> Dispatcher[Worker Manager 任务分派]
                Dispatcher --> Scheduler[Scheduler 定时器驱动模块]
                
                Scheduler --> FS[Farm Service 农场服务]
                Scheduler --> FriendS[Friend Service 好友互动]
                Scheduler --> TaskS[Task/Mall 其它任务]
                
                FS --> Protocol[Protobuf 序列化]
                FriendS --> Protocol
                
                Protocol --> QQ[QQ 农场服务器端]
                Protocol -.-> Tencent[腾讯挂机验证校验]
            end
            
            subgraph Data & Storage
                Engine -.-> JSON[(配置与状态 store.json)]
                Engine -.-> SQLite[(农场核心库 farm-bot.db)]
            end
        </div>
    </div>

    <div class="card">
        <h2>3. 关键业务逻辑链分析</h2>
        
        <h3>3.1 农场循环生命周期与极限保护机制</h3>
        <ul>
            <li><strong>常规巡查流：</strong> 收获 -> 播种 -> 浇水 -> 除草 -> 除虫 -> 施肥（自动判断等级与收益配置）。</li>
            <li><strong><span class="tag warning">高能守护</span> 两季作物防铲机制：</strong> 收获时重新校验土地状态 (`refreshedStatus`)，如检测到处于第一季刚收获后的成长态，系统将挂起对该地块的清理，确保第二季安全过渡，防止被当成枯树铲除。</li>
            <li><strong><span class="tag danger">无缝防偷</span> 60秒极限拦截：</strong> 巡田时若发现作物剩余时间在 10 分钟内，将直接向内存中的 <code>farmScheduler</code> 推入精准倒计时任务。在成熟前最后 60 秒内爆发式执行 <code>秒熟化肥 + 瞬间收获</code> API 的原子组合请求，利用毫秒级误差使得其它挂机机器人或好友根本无法看到成熟状态下的作物，抹除被偷可能。</li>
        </ul>
        <div class="mermaid">
        sequenceDiagram
            participant T as 定时器引擎
            participant Farm as 农场引擎 (farm.js)
            participant TX as 腾讯服务器
            T->>Farm: 触发分析巡田
            Farm->>TX: 获取土地状态 (getAllLands)
            TX-->>Farm: 返回各土地剩余时间与状态
            alt 剩余时间 <= 10分钟
                Farm->>T: 发送 60秒精准唤醒回调任务
                T->>Farm: 等至 T-60秒 触发抢收动作
                Farm->>TX: 发送 (打化肥 + 收获) 并发包
            else 已经成熟
                Farm->>TX: 常规收获动作
                TX-->>Farm: 成功
                Farm->>TX: 验证是否为两季(查询重置状态)
            end
        </div>

        <h3>3.2 社交与池化管理机制（偷菜与防偷）</h3>
        <ul>
            <li><strong>好友与植物过滤双轨制：</strong> 用户可在前端灵活勾选“好友黑白名单”与“植物价值黑白名单”，引擎在循环执行偷窃时，执行前置位多维度校验。</li>
            <li><strong>静默时间控制：</strong> 支持配置 <code>Quiet Hours</code>（例如凌晨 2 点 - 6 点），此期间不对好友执行任何交互动作以降低风控检测与打扰风险。</li>
            <li><strong>秒级全自动扩建（好友申请无感通过）：</strong> 搭配 QQ 互联接口轮询 <code>friendCheckLoop</code> 和事件推送，遇到新的添加好友申请会自动静默同意，无需手工上号，为互刷农场好友提供自动化温床。</li>
        </ul>

        <h3>3.3 账号体系与在线风控运维</h3>
        <ul>
            <li><strong>QQ 协议持久化：</strong> 基于 HTTP Polling 与 ProtoBuf 组合通信，账号生命周期引入轮询鉴权检测。</li>
            <li><strong>掉线重连策略：</strong> 遇到被踢掉或 Session 失效的情况，会自动转入本地错误队列，并支持向绑定的渠道（Bark/Webhook）推送离线警告，清理异常实例以防止接口封禁。</li>
        </ul>
    </div>

    <div class="card">
        <h2>4. 数据流转与持久化架构</h2>
        <p>本项目目前完成了从存粹的零散 JSON 文件面向关系型数据库平滑演进。</p>
        <table>
            <thead>
                <tr>
                    <th>层级</th>
                    <th>存储栈</th>
                    <th>主要职责与数据结构</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>关系型数据</strong></td>
                    <td>SQLite 3<br><code>better-sqlite3</code></td>
                    <td>位于 <code>core/data/farm-bot.db</code>，用于承载全量业务历史、账号鉴权列表 (accounts) 以及核心运行时参数配置。支持防损落盘以应对断电重启及热备份。</td>
                </tr>
                <tr>
                    <td><strong>零散配置与锁</strong></td>
                    <td>JSON DB 工具类</td>
                    <td>用于非范式化存储。实现了文件锁 (File Lock) 及重试原子写入机制 (Atomic Write)，防止多 Worker 并发修改同文件导致文件全量清空损毁。</td>
                </tr>
                <tr>
                    <td><strong>视图状态</strong></td>
                    <td>Pinia</td>
                    <td>用于浏览器端前端状态缓存，提供 <code>account.ts</code>, <code>farm.ts</code> 防抖分发。</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>5. 总体结论及未来建议</h2>
        <p>本次 2.1 升级实现了业务内聚，极大剔除了此前版本中为了迎合商业租户而制造的冗余设计，<strong>现在的流转架构极具极客性质与极致性能追求。</strong><br/>系统充分发挥了 Node Worker 异步非阻塞的特点，结合 node-cron 完成的动态毫秒级补偿延时等特殊队列支持，已经足以应对日常几乎 100% 的极小误差偷菜、防偷场景。</p>
        <p><strong>后续技术迭代建议：</strong></p>
        <ol>
            <li>在频繁读写的持久化流程中，可对 SQLite 启用 <code>WAL</code>（预写式日志）模式提高吞吐并消除读写争用。</li>
            <li>针对于批量执行高并发好友偷菜包推送的场景，建议在 Axios / Native Fetch 上做池化连接层限制 (MaxSockets)，以防触发腾讯的 QPS 高频风控防御（如限制每秒 5 串并行）。</li>
        </ol>
    </div>
</div>

</body>
</html>
