<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan - è‡ªåŠ¨é€šè¿‡å¥½å‹ä¸60ç§’é˜²å·æ–½è‚¥åŠŸèƒ½</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --container-bg: #161b22;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --highlight-bg: #1f2428;
            --success-color: #2ea043;
            --warning-color: #f0883e;
            --danger-color: #f85149;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 2rem;
            font-size: 14px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        h1,
        h2,
        h3 {
            color: #ffffff;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-top: 1.5em;
        }

        h1 {
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 15px;
            color: var(--accent-color);
        }

        p {
            margin-bottom: 1em;
        }

        ul,
        ol {
            margin-bottom: 1em;
            padding-left: 2rem;
        }

        li {
            margin-bottom: 0.5em;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .alert-info {
            border-left-color: var(--accent-color);
        }

        .alert-warning {
            border-left-color: var(--warning-color);
        }

        code {
            background-color: rgba(110, 118, 129, 0.4);
            padding: 0.2em 0.4em;
            border-radius: 6px;
            font-family: ui-monospace, SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 85%;
        }

        pre {
            background-color: var(--highlight-bg);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }

        pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }

        /* æ ‡ç­¾é¡µä¸çŠ¶æ€æ ·å¼ */
        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 75%;
            font-weight: 600;
            border-radius: 12px;
            background-color: rgba(56, 139, 253, 0.15);
            color: #79c0ff;
        }

        .badge-success {
            background-color: rgba(46, 160, 67, 0.15);
            color: #56d364;
        }

        .tag-update {
            color: #3fb950;
            font-weight: bold;
        }

        .tag-new {
            color: #a371f7;
            font-weight: bold;
        }
    </style>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    </script>
</head>

<body>
    <div class="container">
        <h1>è§„åˆ’æŠ¥å‘Š (Plan) ğŸš€: è‡ªåŠ¨åŒæ„å¥½å‹ä¸60ç§’é˜²å·</h1>
        <p><strong>æ—¥æœŸ:</strong> 2026-02-28 &nbsp;|&nbsp; <strong>çŠ¶æ€:</strong> å¾…å®¡æ‰¹ (User Approval Pending)</p>

        <div class="alert alert-info">
            <strong>ç°çŠ¶è¯Šæ–­ç»“è®º:</strong> æ‚¨æä¾›çš„æˆªå›¾ä¸­åŒ…å«äº†åˆ«äººç¨‹åºï¼ˆå¤–ç½‘ç‰ˆæˆ–æ—§å›¾ï¼‰é‡Œçš„â€œè‡ªåŠ¨åŒæ„å¥½å‹â€ä¸â€œ60ç§’æ–½è‚¥(é˜²å·)â€æŒ‰é’®ã€‚ç»è¿‡å¯¹æˆ‘æ–¹æºç åˆ†æï¼Œå½“å‰å‰ç«¯å’Œåç«¯å‡æœªå®ç°è¿™ä¸¤ä¸ªè‡ªåŠ¨åŒ–çš„ä¸šåŠ¡åŠŸèƒ½ã€‚åº•å±‚
            API `acceptFriends` å­˜åœ¨ä½†æœªè¢«è°ƒç”¨ã€‚
            ä¸‹é¢æ˜¯å…³äºå¦‚ä½•åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­å®Œå…¨å†…åŒ–å®ç°è¿™ä¸¤ä¸ªåŠŸèƒ½çš„è¯¦ç»†è®¡åˆ’ã€‚
        </div>

        <h2>1. æ¶æ„ä¸æµç¨‹è®¾è®¡ (Architecture)</h2>
        <p>è¿™ä¸¤ä¸ªåŠŸèƒ½äº’ä¸å¹²æ¶‰ï¼Œå…¶ä¸­â€œè‡ªåŠ¨åŒæ„å¥½å‹â€é‡‡ç”¨æ¾æ•£çš„å®šæœŸè½®è¯¢æ¨¡å¼ï¼Œâ€œ60ç§’æ–½è‚¥â€å±äºå¼ºå®æ—¶è¦æ±‚çš„ç²¾å‡†åŠ¨ä½œï¼Œéœ€è¦å€ŸåŠ©è°ƒåº¦å™¨é˜Ÿåˆ—å®ç°å€’è®¡æ—¶å”¤é†’ã€‚</p>

        <h3>è®¾è®¡æ—¶åºå›¾ (Mermaid)</h3>
        <div class="mermaid">
            sequenceDiagram
            participant User as å‰ç«¯ UI (Settings.vue)
            participant Store as åç«¯çŠ¶æ€å±‚ (store.js)
            participant Friend as å¥½å‹å¼•æ“ (friend.js)
            participant Farm as å†œåœºå¼•æ“ (farm.js)

            User->>Store: ä¿å­˜å¼€å¯ `friend_auto_accept`
            User->>Store: ä¿å­˜å¼€å¯ `fertilizer_60s_anti_steal`

            note over Friend: è‡ªåŠ¨åŒæ„å¥½å‹æµç¨‹
            loop å®šæ—¶æ£€æŸ¥ (ä¾‹å¦‚æ¯20åˆ†é’Ÿ)
            Friend->>Friend: æ£€æŸ¥ friend_auto_accept == true
            Friend->>GameServer: getApplications()
            alt å­˜åœ¨ç”³è¯·
            Friend->>GameServer: acceptFriends([gids...])
            Friend-->>ç»ˆç«¯: [æ—¥å¿—] è‡ªåŠ¨åŒæ„äº†Xä½å¥½å‹
            end
            end

            note over Farm: 60ç§’æ–½è‚¥é˜²å·æˆªèƒ¡æµç¨‹
            Farm->>GameServer: è¿è¡Œ checkFarm()
            GameServer-->>Farm: è¿”å›ä¸€å—åœŸåœ°æƒ…å†µ (å‰©ä½™æˆç†Ÿæ—¶é—´ 90ç§’)
            Farm->>Farm: æ£€æŸ¥ fertilizer_60s_anti_steal == true ä¸” (60 < å‰©ä½™ç§’ < å½“å‰æ™®é€šåŒ–è‚¥æ—¶é—´) Farm->>Farm:
                ä¸ç«‹åˆ»æ–½è‚¥æˆ–æ”¶è·ï¼Œå‘è‡ªå·±(è°ƒåº¦å™¨)æ³¨å†Œå”¤é†’äº‹ä»¶ (ç›®æ ‡: å‰©ä½™ 60ç§’ æ—¶)

                note right of Farm: ç­‰å¾… 30 ç§’å€’è®¡æ—¶ç»“æŸ...å”¤é†’

                Farm->>GameServer: fertilize(landId, 1011) [æ–½æ”¾æ™®é€šåŒ–è‚¥ç¬é—´æˆç†Ÿ]
                GameServer-->>Farm: æ–½è‚¥æˆåŠŸ, æˆç†Ÿ
                Farm->>GameServer: harvest(landId) [æ¯«ç§’çº§è·Ÿè¿›æ”¶è·]
                Farm-->>ç»ˆç«¯: [æ—¥å¿—] åœŸåœ°è¿›è¡Œ60ç§’é˜²å·æˆªèƒ¡å¹¶æ”¶è·å®Œæˆï¼
        </div>

        <h2>2. å½±å“é¢ä¸å˜æ›´å†…å®¹åˆ†æ (Impact Analysis)</h2>

        <h3><span class="tag-update">[UPDATE]</span> å‰ç«¯ (web)</h3>
        <ul>
            <li><code>web/src/views/Settings.vue</code>
                <br>&nbsp;- åœ¨ <code>localSettings.automation</code> æ•°æ®ç»“æ„ä¸­å¢åŠ  <code>friend_auto_accept</code> å’Œ
                <code>fertilizer_60s_anti_steal</code>, å¹¶æ˜ å°„ä¸­æ–‡å­—æ®µåç§°ã€‚
                <br>&nbsp;- åœ¨å¯¹åº”çš„è®¾ç½®é¢æ¿åŒºå—ä¸­ï¼ˆâ€œç¤¾äº¤äº’åŠ¨è¯¦ç»†ç­–ç•¥â€ä¸â€œåŒ–è‚¥ä¸ç²¾ç»†æ§åˆ¶â€ï¼‰å„è¡¥ä¸Šä¸€ä¸ªæ–°çš„ <code>&lt;BaseSwitch&gt;</code> é€‰é¡¹æŒ‰é’®ã€‚
            </li>
        </ul>

        <h3><span class="tag-update">[UPDATE]</span> åç«¯å­˜å‚¨ä¸æ¨¡å‹ (core)</h3>
        <ul>
            <li><code>core/src/models/store.js</code>
                <br>&nbsp;- æ–°å¢è‡ªåŠ¨åŒ–è¿‡æ»¤å±æ€§ <code>friend_auto_accept</code> (é»˜è®¤ <code>false</code>)ã€‚
                <br>&nbsp;- æ–°å¢è‡ªåŠ¨åŒ–è¿‡æ»¤å±æ€§ <code>fertilizer_60s_anti_steal</code> (é»˜è®¤ <code>false</code>)ã€‚
            </li>
        </ul>

        <h3><span class="tag-new">[NEW & UPDATE]</span> åç«¯æ ¸å¿ƒé€»è¾‘ (core)</h3>
        <ul>
            <li><code>core/src/services/friend.js</code>
                <br>&nbsp;- æš´éœ² `autoAcceptFriendsLoop()`ã€‚åœ¨ä¸»å†œåœºè¿è¡Œæˆ–å¥½å‹å·¡ç”°æ£€æŸ¥å¼€å§‹æ—¶ï¼Œå¼‚æ­¥è§¦å‘ `getApplications()`ï¼Œå¦‚æœ‰æ•°æ®ç›´æ¥è°ƒç”¨
                `acceptFriends()`ã€‚
            </li>
            <li><code>core/src/services/farm.js</code>
                <br>&nbsp;- ä¿®æ”¹ç°æœ‰çš„ç§æ¤ç®¡ç†è½®è¯¢é€»è¾‘æˆ– `analyzeLands`ã€‚
                <br>&nbsp;- æ£€æµ‹ï¼šå¦‚æœ `fertilizer_60s_anti_steal` æ˜¯å¼€å¯çŠ¶æ€ï¼Œåˆ™å¯¹äº `matureInSec` å¤„äºå¤§äº60ä¸”å°äºæŸé˜ˆå€¼ï¼ˆé˜²æ­¢å¤ªä¹…ï¼‰çš„æƒ…å†µï¼Œç›´æ¥
                `farmScheduler.schedule(..., targetTime)` å‘èµ·ä¸€ä¸ªä¸€æ¬¡æ€§çš„å»¶æ—¶è¡ŒåŠ¨ã€‚
                <br>&nbsp;- è¯¥å»¶æ—¶è¡ŒåŠ¨è§¦å‘ï¼šè°ƒç”¨ `fertilize()`ï¼Œæ ¡éªŒæˆåŠŸåé©¬ä¸Šè§¦å‘å¯¹åº”çš„ `harvest()` åŠ¨ä½œï¼Œå½¢æˆä¸€æ°”å‘µæˆçš„è¿æ‹›ã€‚åŒæ—¶è®°å½•å¯¹åº”çš„æ“ä½œæ—¥å¿—ï¼Œå‘ŠçŸ¥ç”¨æˆ·æˆåŠŸé˜²å·ã€‚
            </li>
        </ul>

        <h2>3. æ½œåœ¨é£é™©ä¸ç¼“è§£ (Risks & Mitigations)</h2>
        <div class="alert alert-warning">
            <ul>
                <li><strong>èƒŒåŒ…é£é™©ï¼š</strong> å¦‚æœ 60 ç§’æ—¶è§¦å‘äº†å”¤é†’ï¼Œä½†è´¦å·å†…æ™®é€šåŒ–è‚¥å·²è¢«ç”¨å…‰ï¼Œè¯¥æ¥å£ä¼šæŠ¥é”™ã€‚æˆ‘ä»¬åœ¨ä»£ç é‡Œå¿…é¡»ç”¨ <code>try/catch</code> æ•è·
                    <code>fertilize</code>ã€‚å¦‚æœæŠ¥é”™ï¼Œä¸åº”ä¸­æ–­ç¨‹åºï¼Œè€Œæ˜¯é‡æ–°è®¡ç®—å¹¶å°†å…¶åŠ å…¥æ­£å¸¸çš„æˆç†Ÿæ”¶è·é˜Ÿåˆ—ï¼ˆç­‰ 60 ç§’åæ­£å¸¸æ”¶ï¼‰ã€‚</li>
                <li><strong>åç¨‹æ‹¥å¡ï¼š</strong> åœ¨æ–½è‚¥ç¬é—´ï¼Œä¸ºäº†æé€ŸæŠ¢æ”¶ï¼Œéœ€è¦åœ¨ await fertilize åä¸åŠ é•¿ç¡çœ ï¼Œç›´æ¥ç«‹åˆ»æäº¤ harvest ä»¥ç¡®ä¿æŠ¢åœ¨å¥½å‹å‰é¢ã€‚è¿™å¯èƒ½ä¼šè§¦å‘ QPS
                    é™åˆ¶ï¼Œéœ€è¦ç•™æ„ 50ms å·¦å³çš„ç¼“å…µä¹‹è®¡ã€‚</li>
                <li><strong>åŒæ„å¥½å‹é™é¢‘ï¼š</strong> å¥½å‹åˆ—è¡¨ä¸æ˜¯å¿…é¡»è¦æ—¶æ—¶åˆ»åˆ»æ‹‰å–ï¼Œæ¯ 30 åˆ†é’Ÿæ‹‰å–ä¸€æ¬¡ç”³è¯·åˆ—è¡¨å³å¯æå¤§åœ°èŠ‚çœæœåŠ¡å™¨è¯·æ±‚é‡å¹¶é˜²æ­¢æ‹‰é»‘ã€‚</li>
            </ul>
        </div>

        <h2>4. ä½ çš„å†³ç­–ï¼(Next Action)</h2>
        <p>ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬é’ˆå¯¹ç›®å‰æ²¡æœ‰çš„è¿™ä¸¤ä¸ªåŠŸèƒ½æ‰€å‡ºå…·çš„å®ç°è®¡åˆ’ã€‚<br>
            å¦‚æœæ‚¨åŒæ„æŒ‰æ­¤é€»è¾‘è¿›è¡Œç¼–å†™ï¼Œè¯·å›å¤ï¼š<strong>â€œåŒæ„è®¡åˆ’ï¼Œå¼€å§‹ç¼–å†™ä»£ç â€</strong>ã€‚æˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆè¿™äº›åº•å±‚é€»è¾‘åŠ UI æ›´æ–°ä»£ç ï¼ˆåŒ…å«æµ‹è¯•é©±åŠ¨çš„æ€è·¯ï¼ï¼‰ã€‚</p>
    </div>
</body>

</html>