<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>微信扫码登录实施计划 (Plan)</title>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            background: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #1e1e1e;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }

        h1,
        h2,
        h3 {
            color: #ffffff;
            border-bottom: 1px solid #333;
            padding-bottom: 0.5rem;
        }

        code {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #ffab70;
        }

        .mermaid {
            background: transparent;
            display: flex;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .impact-section {
            padding: 1rem;
            border-left: 4px solid #64b5f6;
            background: #263238;
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }
    </style>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    </script>
</head>

<body>
    <div class="container">
        <h1>微信扫码登录 - 架构设计与实施计划</h1>

        <h2>1. 功能目标</h2>
        <p>通过整合外部聚合API（<code>api.aineishe.com</code>），在现有添加账号流程的“扫码登录”环节中，并列提供“微信小程序”的安全扫码登录能力，与原有的QQ登录相统一。</p>

        <h2>2. 系统架构与数据流</h2>
        <div class="mermaid">
            sequenceDiagram
            autonumber
            actor User as 用户 (前端)
            participant FE as AccountModal.vue
            participant API as Backend (admin.js)
            participant WX_API as 外部微信聚合API

            User->>FE: 选择"微信平台"并点击"扫码登录"
            FE->>API: POST /api/qr/create { platform: "wx" }
            API->>WX_API: POST action=getqr (附带 api_key)
            WX_API-->>API: 返回 QrBase64 与 uuid
            API-->>FE: 返回二维码图像供用户扫描

            loop 每秒轮询
            FE->>API: POST /api/qr/check { code: uuid, platform: "wx" }
            API->>WX_API: POST action=checkqr (轮询扫码状态)
            WX_API-->>API: 状态返回 (未扫码=1/已扫码=0)
            end

            opt 扫码成功
            API->>WX_API: POST action=jslogin 获取授权详情
            WX_API-->>API: 返回 wxid, nickname, Code
            API-->>FE: 返回账户凭据 status: "OK", code: "auth_code"...
            end

            FE->>User: 提示"登录成功"
            FE->>API: POST /api/accounts (提交账号入库)
        </div>

        <h2>3. 影响面分析 (Impact Analysis)</h2>
        <div class="impact-section">
            <p><strong>核心影响文件：</strong></p>
            <ul>
                <li><code>core/src/controllers/admin.js</code>：修改前后端二维码交互逻辑。原有代码采用原生
                    <code>MiniProgramLoginSession</code> 提取，新版对上层保持 100% 接口兼容，通过下放 <code>platform</code>
                    判断策略做分流。不影响QQ用户体系。</li>
                <li><code>web/src/components/AccountModal.vue</code>：仅增强 UI（增设 Platform 下拉选框）及 <code>api.post</code>
                    带参扩展，风险评级 <strong>极低</strong>。</li>
            </ul>
        </div>

        <h2>4. 部署与后续</h2>
        <p>该功能纯粹基于后端 NodeJS 运行期的 fetch 请求，无数据库 Scheme 修改，平滑接入即可。</p>
    </div>
</body>

</html>