<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜²å·æ–½è‚¥ç³»ç»Ÿï¼šå®æ—¶äºŒæ¬¡æ ¡éªŒ (Double Check) è®¾è®¡æ–¹æ¡ˆ</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --success-color: #2ea043;
            --warning-color: #d29922;
            --danger-color: #f85149;
            --card-bg: #161b22;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1,
        h2,
        h3 {
            color: #fff;
        }

        h1 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            text-align: center;
        }

        h2 {
            color: var(--accent-color);
            margin-top: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3rem;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .mermaid-container {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
        }

        .impact-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .impact-analysis {
                grid-template-columns: 1fr;
            }
        }

        ul {
            padding-left: 1.5rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background-color: rgba(110, 118, 129, 0.4);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
            font-size: 85%;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }

        .status-danger {
            background-color: rgba(248, 81, 73, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .status-success {
            background-color: rgba(46, 160, 67, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: { curve: 'basis' }
        });
    </script>
</head>

<body>

    <h1>é˜²å·æ–½è‚¥ç³»ç»Ÿï¼šå®æ—¶äºŒæ¬¡æ ¡éªŒ (Double Check)</h1>
    <p style="text-align: center; color: var(--border-color);">è®¾è®¡æ—¶é—´: 2026-02-28 | å¯†çº§: æ ¸å¿ƒæ¶æ„æ›´æ–°</p>

    <div class="card">
        <h2>ğŸ›  æ¶æ„æ¼”è¿›è¯´æ˜</h2>
        <p>
            å½“å‰çš„ <code>antiStealHarvest</code>
            é‡‡å–äº†ä¹è§‚ç›²è°ƒç”¨çš„è®¾è®¡ï¼ˆå‡è®¾æ¡ä»¶ä¸€æˆä¸å˜ï¼‰ã€‚ä½†ç©å®¶åœ¨å†œåœºç³»ç»Ÿä¸­å¯éšæ„å¯¹å€’è®¡æ—¶å†…çš„ä½œç‰©å‘èµ·æ”¶å‰²å¹²é¢„ï¼ˆä¾‹å¦‚é¡ºæ‰‹äººå·¥ç‚¹åŒ–è‚¥ç§’æ”¶å¹¶å¿«é€Ÿç§äº†ä¸€é¢—æ–°çš„äººå‚æœï¼‰ã€‚å¯¹äºå†…å­˜å®šæ—¶å™¨è€Œè¨€ï¼Œè‹é†’æ—¶åˆ»é¢ä¸´çš„åœ°å—ä¸å†æ˜¯é¢„æœŸä¸­çš„ç›®æ ‡ï¼Œå¦‚æœä¸åŠ ä»¥éªŒè¯ï¼Œå®ƒä¼šå¯¹ç€â€œå¹¼è‹—â€ç›´æ¥å–·æ´’åŒ–è‚¥é€ æˆçè´µåŒ–è‚¥æµªè´¹ã€‚
        </p>
        <p>
            ä¸ºå®ç°åšä¸å¯æ‘§çš„å®‰å…¨å£å’ï¼Œæˆ‘ä»¬åœ¨å®ƒå”¤é†’çš„ç¬¬ä¸€æ—¶é—´æ¤å…¥ <strong>å®å†µæ¢é’ˆ (State Probing)</strong>ã€‚
        </p>
    </div>

    <h2>ğŸ“ˆ æ—¶åºä¸æ•°æ®æµè®¾è®¡</h2>
    <div class="card">
        <p>å½“ 60 ç§’å®šæ—¶å™¨ä»é˜Ÿåˆ—ä¸­é‡Šæ”¾æ—¶ï¼Œä¸¥æ ¼æ‰§è¡Œä»¥ä¸‹é“¾è·¯ï¼š</p>
        <div class="mermaid-container">
            <div class="mermaid">
                sequenceDiagram
                participant Scheduler as è°ƒåº¦å™¨ (farmScheduler)
                participant Bot as é˜²å·å¼•æ“ (farm.js)
                participant API as æ¸¸æˆæœåŠ¡ç«¯ (QQ API)

                Scheduler->>Bot: æ—¶é—´åˆ°ï¼Œå”¤é†’é’ˆå¯¹åœ°å— [X] çš„æŠ¢æ”¶
                Note over Bot: å¼€å¯å®æ—¶çŠ¶æ€æ¢æµ‹ (Double Check)
                Bot->>API: å¼ºæ‹‰æœ€æ–°å…¨é‡åœ°å—æ•°æ® (getAllLands)
                API-->>Bot: è¿”å›æœ€æ–°æ‰€æœ‰åœŸåœ°å’Œæ¤ç‰©å…ƒä¿¡æ¯

                Bot->>Bot: æå–åœ°å— [X] çš„ plant_id ä¸å€’è®¡æ—¶

                alt ã€è¿è§„ã€‘æ²¡æœ‰æ¤ç‰©æˆ–æ¤ç‰©å·²æ­»äº¡
                Bot->>Scheduler: [é™é»˜å–æ¶ˆ] å–æ¶ˆæ“ä½œï¼Œè®°å½•æ—¥å¿—ä¿æŠ¤æ‹¦æˆª
                else ã€è¿è§„ã€‘è¢«äººå·¥å¤„ç†ï¼Œè·ç¦»æˆç†Ÿå¤§äº100ç§’
                Bot->>Scheduler: [æ‹¦æˆª] åˆ¤å®šä¸ºå¤ç§çš„æ–°è‹—ï¼Œæ”¾å¼ƒæ–½è‚¥
                else ã€è¿è§„ã€‘å·²ç»è¢«äººå·¥æå‰æ”¶è· (æˆç†Ÿå€’æ•°ä¸º<=0) Bot->>Scheduler: [æ‹¦æˆª] åˆ¤å®šå·²æˆç†Ÿæˆ–æ— æ”¶ç›Šï¼Œç»ˆæ­¢å¹¶ä¸¢å¼ƒå€’è®¡æ—¶
                    else ã€åˆè§„ã€‘è·ç¦»æˆç†Ÿä»å¤„äºæ­£å¸¸çš„ (0ï¼Œ65] ç§’é—­ç¯ä¹‹å†…
                    Note over Bot: äºŒæ¬¡æ ¡éªŒé€šè¿‡ï¼Œç¬¦åˆæŠ¢æ”¶ç‰¹å¾
                    Bot->>API: å¼ºåŠ›è§¦å‘[ä½¿ç”¨åŒ–è‚¥] (fertilize)
                    API-->>Bot: å‚¬ç†ŸæˆåŠŸåé¦ˆ
                    Bot->>API: ç¬é—´æ‰§è¡Œ[æ”¶å‰²] (harvest)
                    API-->>Bot: æŠ¢æ”¶æˆåŠŸï¼
                    end
            </div>
        </div>
    </div>

    <h2>ğŸ” å½±å“é¢åˆ†æ (Impact Analysis)</h2>
    <div class="impact-analysis">
        <div class="card">
            <h3 style="display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--danger-color)"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                å®æ–½å‰é£é™©
            </h3>
            <ul>
                <li><strong>çŠ¶æ€æ¼‚ç§»</strong>ï¼šæ—¶é—´å…·æœ‰æ¬ºéª—æ€§ï¼Œç©å®¶å¯èƒ½æ‰“æ–­å€’è®¡æ—¶</li>
                <li><strong>åŒ–è‚¥æµªè´¹</strong> <span class="status-badge status-danger">æé«˜</span>ï¼šå¯¹ç€é«˜çº§ç§å­ç™½æ‰”åŒ–è‚¥äº§ç”Ÿé›¶æ”¶ç›Š</li>
                <li><strong>è¯¯å¯¼æ€§æ—¥å¿—</strong>ï¼šæ˜æ˜å¤±è´¥ï¼Œæ—¥å¿—å´æŠ¥é”™ç”šè‡³è°æŠ¥æˆåŠŸ</li>
            </ul>
        </div>
        <div class="card">
            <h3 style="display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success-color)"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                å®æ–½åçº¢åˆ©
            </h3>
            <ul>
                <li><strong>å¼ºå£®æŠ¤ç›¾</strong>ï¼šå“ªæ€•ç³»ç»Ÿé‡å¯ã€æ—¶é—´å›æº¯ã€ç”¨æˆ·äººä¸ºæ“ä½œå‡ä¸è™š</li>
                <li><strong>èµ„æºé›¶ç£¨æŸ</strong> <span class="status-badge status-success">ä¿éšœ</span>ï¼šæ— è°“æ–½è‚¥äº‹ä»¶æ¦‚ç‡é™è‡³ 0%</li>
                <li><strong>ç²¾å‡†çš„æ—¥å¿—è·Ÿè¸ª</strong>ï¼šæ¯æ¬¡æ“ä½œå‰æ‹¥æœ‰çœŸå®çš„ä¸Šå¸è§†è§’ï¼Œæ‹¦æˆªå¯è§</li>
            </ul>
        </div>
    </div>

    <h2>ğŸš€ æ‰§è¡Œæ­¥éª¤è§„åˆ’</h2>
    <div class="card">
        <ol>
            <li>
                <strong>æ ¸å¿ƒä»£ç ä¿®æ”¹</strong>ï¼šåœ¨ <code>core/src/services/farm.js</code> çš„å‡½æ•°
                <code>antiStealHarvest(landId)</code> å¼€å¤´å¢è®¾ <code>Double Check</code>ã€‚
            </li>
            <li>
                <strong>APIè°ƒç”¨æ¤å…¥</strong>ï¼šæ‹‰å– <code>const landsReply = await getAllLands();</code>
            </li>
            <li>
                <strong>çŠ¶æ€æ ¸ç®—è§„åˆ™</strong>ï¼š
                <pre>
<code>
const maturePhase = plant.phases.find(p => p.phase === PlantPhase.MATURE);
const matureInSec = toTimeSec(maturePhase.begin_time) - getServerTimeSec();

if (matureInSec <= 0 || matureInSec > 65) {
    // æ‹¦æˆªï¼å–æ¶ˆæ–½è‚¥
    return;
}
</code>
                </pre>
            </li>
            <li>
                <strong>è®°å½•æ—¥å¿—</strong>ï¼šå¯¹è¢«æ‹¦æˆªæˆ–å…ç–«çš„äº‹ä»¶ç™»è®°æ—¥å¿—ä¾›å¤ç›˜è·Ÿè¸ªã€‚
            </li>
        </ol>
    </div>

</body>

</html>