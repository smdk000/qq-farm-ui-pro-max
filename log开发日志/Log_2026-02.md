# 开发日志 - 2026年02月

## 2026-02-28 23:59
- **修改类型**: 架构沉淀、体验修复与上游特性合并 (v3.2.8 & v3.2.9)
- **摘要**:
  1. **防偷逻辑加固 (Double Check)**: 重构了防偷抢收机制的底座。在化肥唤醒时强制加入 `getAllLands()` 实况二次核验，拦截跨端手动作物铲除、意外枯萎引发的状态时延偏移，彻底杜绝化肥空扔浪费。
  2. **UnoCSS 排版穿透 Bug 修复**: 移除了 `StealSettings.vue` 及 `Settings.vue` 中错误附加在 `BaseSwitch` / `BaseSelect` 上的 `size="sm"` 属性，解决组件被过度撑开留白的奇葩布局异常。
  3. **SQLite 与 WS 通讯并发梳理**: 加入 `busy_timeout` 与 WAL Checkpoint 拦截高频 I/O 争用；在 WS 发送口布设核心令牌桶 (Token Bucket) 限流器，强制 `3 QPS` 物理发包上限，极致避免风控。
  4. **开源上游优秀补丁合并 (v2.0.2)**: 导入并改进了有机肥施加保护时长 (延至 500ms)、分离修复了玩家改名被接口 `nick` 覆写的毒性覆盖逻辑、修补了底层 `process.uptime()` 上报导致系统运转计时出格的问题，并为前端增加了无缝点选账号及好友极速搜索功能。
- **涉及文件**:
  - `core/src/services/farm.js`
  - `core/src/services/database.js`
  - `core/src/services/stats.js`
  - `core/src/utils/network.js`
  - `core/src/runtime/worker-manager.js`
  - `web/src/views/Accounts.vue`
  - `web/src/views/Friends.vue`
  - `web/src/views/Settings.vue`
  - `web/src/views/StealSettings.vue`
  - `CHANGELOG.md`

## 2026-02-28 23:00
- **修改类型**: 核心业务自动化扩展 (v3.2.7)
- **摘要**:
  1. 增加了**自动同意好友**功能：底层利用 `friendApplicationReceived` 接收推送以及 `friendCheckLoop` 定时双效轮询，高效批量通过 `acceptFriendsWithRetry`。
  2. 增加了**60秒极限抢收防偷**机制：在农场周期扫描 `analyzeLands` 时预埋倒计时守护任务。在作物成熟前 60 秒触发 `antiStealHarvest`，智能尝试使用普通化肥催熟并以毫秒级时差跟进收获。若化肥耗尽自动降级。
  3. 前后端实现 `friend_auto_accept` 及 `fertilizer_60s_anti_steal` 的状态同步，在 `Settings.vue` 增设开关入口，并解决 TypeScript 类型声明警告。
- **涉及文件**:
  - `core/src/services/friend.js`
  - `core/src/services/farm.js`
  - `core/src/models/store.js`
  - `web/src/views/Settings.vue`
  - `CHANGELOG.md`

## 2026-02-28 20:45
- **修改类型**: UI 重构与功能增强 (v3.2.6 & v3.2.3 累积)
- **摘要**:
  1. `Settings.vue` 界面彻底采用响应式 3 列网格化与逻辑分组展现，消除了原来长达几十个平铺开关的混乱感；增强了高度自适应（`items-start`）收缩避免底部大片留白。
  2. 对接了 `docs/SETTINGS_GUIDE.md` 规范，实现**三种自动策略预设面板**（保守、平衡、激进），辅以改动高亮预览和快速保存闭环。有效预防用户误触并省去滚动困扰。
  3. `Dashboard.vue` 的筛选条件利用 `@vueuse/core` `useStorage` 升级为离线防抖缓层持久化，告别刷新丢状态。
  4. 加入了防呆的列表全选功能（蔬菜过滤及好友过滤）。
  5. 侧边栏增加指向了帮助中心的入口。
- **涉及文件**:
  - `web/src/views/Settings.vue`
  - `web/src/views/Dashboard.vue`
  - `web/src/components/Sidebar.vue`
  - `web/src/components/AccountModal.vue`
  - `CHANGELOG.md`

## 2026-02-28 21:38
- **修改类型**: 安全与交互防呆重构 (v3.2.6 追加)
- **摘要**:
  1. 重构了 `AccountModal.vue` 中移动端点击“扫码登录”时唤起 QQ App 的逻辑。
  2. 废弃了简陋且无法有效捕获系统级深链接（Deep Link）调起失败的 `try-catch`。
  3. 引入基于客户端焦点切换侦测的 `visibilitychange` 事件方案，同时采纳架构师对容错时间的建议，将安全回退限时设定为 `1500` 毫秒冗余值。若应用超时未呼出则重定向至普通 H5 网页登录，实现零断层的降级体验。
- **涉及文件**:
  - `web/src/components/AccountModal.vue`
  - `CHANGELOG.md`

## 2026-02-28 21:10
- **修改类型**: 性能架构演进与底层数据库重构 (v3.2.5)
- **摘要**:
  1. 构建 SQLite 增量迁移脚本 (`PRAGMA user_version`)，加入 `002-optimize_storage.sql` 确保无缝且安全的数据库变更升级。
  2. 引入 `daily_statistics` 表存储日增聚合数据（经验、金币），减少长周期时对 `operation_logs` 的巨量轮询耗时。
  3. 表结构拓宽：`accounts` 表加装 `status` 与 `api_error_count` 便于健康度追踪；`account_configs` 表增加 `advanced_settings` (JSON) 彻底解决新增配置导致频繁刷表结构的痛点。
  4. 实现自动化容灾清理：编写 `logCleanupJob`，由重构的主进程调度器在破晓时分静默剔除 7天以上的陈旧数据，根治挂机日志导致的空间膨胀。
  5. 编译环境加固：修复了 `HelpCenter.vue` 中由冗余变量与多余 `computed` 引入引发的 Vue-TSC 编译崩溃 (Exit Code 2)。
- **涉及文件**:
  - `core/src/services/database.js`
  - `core/src/database/migrations/002-optimize_storage.sql`
  - `core/src/jobs/logCleanupJob.js`
  - `core/src/jobs/dailyStatsJob.js`
  - `core/client.js`
  - `core/src/repositories/account-repository.js`
  - `web/src/views/Analytics.vue`
  - `web/src/views/HelpCenter.vue`
