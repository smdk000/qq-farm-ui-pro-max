# 开发日志 - 2026年03月

## 2026-03-01 16:00
- **修改类型**: 登录链路拓展与全端融合 (v3.4.0+)
- **摘要**:
  1. **多平台扫码登录引擎**: 针对添加账号系统，引入了外部扫码探针(aineishe)。支持前端在统一的扫码视窗内自主切换 QQ/微信 双端的小程序授权登录，底层自适应了多态轮询回调解析。
  2. **编译质量加固**: 拦截并修复了历史代码 `Friends.vue` 在 Vue TypeScript 编译器下由于 `v-for` 结构失配引起的硬性阻断构建问题，清除了 Vite 产物分发隐患。
- **涉及文件**:
  - `core/src/controllers/admin.js`
  - `web/src/components/AccountModal.vue`
  - `web/src/views/Friends.vue`

## 2026-03-01 15:30
- **修改类型**: 持久化换肤Bug修复与多端渲染对齐 (v3.5.1)
- **摘要**:
  1. **前端持久化闭环修复**: 重点攻克了 `colorTheme` (五大高定主题色) 与 `performanceMode` (极简性能模式) 在切换页面/抽屉路由时随机重置为默认值(被覆盖)的顽疾。修正了前后端契约，令后端 `/api/settings/theme` 接口完整接力并落库包含 `ui: { colorTheme, performanceMode }` 在内的全量视图变动。
  2. **高频重绘闪烁排雷**: 解决部分浏览器容器重组引起的渲染残影、短暂闪烁白屏问题，保障了 Glassmorphism 毛玻璃特效层叠上下文 (BFC) 的完整与稳定。
- **涉及文件**:
  - `core/src/controllers/admin.js`
  - `web/src/App.vue`
  - `web/src/stores/app.ts`

## 2026-03-01 12:00
- **修改类型**: Glassmorphism 毛玻璃架构大重构 (v3.5.0)
- **摘要**:
  1. **GPU级高性能变色底基**: 抛弃原有可能造成重绘重排的 `top`/`left` 流动特效，引入基于 `transform: translate() scale()` 的硬件级 Mesh Gradient，有效降低游览器动画开销。
  2. **全面沉浸毛玻璃架构**: 针对侧边栏、顶部栏、农场管理页面、设置抽屉、通知气泡与底层输入框等全部组件，抛弃死板的纯白/黯灰底色，引入了全局抽象 `.glass-panel` 等具有 `backdrop-filter` 效果的新质感容器。
  3. **文字光感与对比度调优**: 为保障深浅双系统无论挂载在何种有色背景下都具备绝佳可读性，统一部署了 `glass-text-main` 与 `glass-text-muted` 增强工具类，解决原 `text-gray-500` 造成的降维失真并满足 WCAG 标准。
- **涉及文件**:
  - 大规模重构：`web/src/components/*` 及 `web/src/views/*` 相关视图，覆盖所有模态框。
  - `web/src/App.vue`


## 2026-03-01 10:00
- **修改类型**: UI架构大重构与体验卡授权系统 (v3.4.0)
- **摘要**:
  1. **独立主题换肤抽屉**: 将左下角主题切换升级为全局右侧抽屉面板，内部集成响应式的太阳/月亮黑夜模式开关，以及全新的 5 大内置主题色（御农翠绿、全息赛博、尊贵黯金、深海矩阵、樱花粉黛），通过 CSS Variable 注入实现丝滑全站换肤。
  2. **图形化偷菜与设置引擎**: 新增独立挂载的「偷菜设置」可视化路由，提供蔬菜与好友的搜索以及批量全选/反选能力。重构原有的自动化卡片配置体验，引入代码级高亮（Diff）变更前校验弹窗，防止用户误触修改导致挂机状态受损。
  3. **自动化自助体验卡**: 从单纯的管理员后台发卡，衍生至前端支持一键「获取体验卡」并在注册时自动带入填充。管理员层面新增了生成的体验卡天数选项、多开账号数量限制配置，保障系统合规拉新。增加用户级别一键「自助续费」捷径。
  4. **暗模式色彩校准**: 针对「帮助中心」及部分通用面板，通过调降白底透明度和降低边框高亮对比度，使深色模式体验进一步趋同护眼标准。
- **涉及文件**:
  - `web/src/components/ThemeSettingDrawer.vue` 等 UI 核心组件
  - `web/src/views/Settings.vue` 及 `StealSettings.vue` 偷菜独立面板
  - `web/src/views/Login.vue` 及 `AccountModal.vue` 注册与表单
  - `core/src/controllers/admin.js` 及用户业务类 API


## 2026-03-01 01:10
- **修改类型**: 高阶架构自检复盘与防雪崩/防饿死熔断机制 (v3.3.2)
- **摘要**:
  1. **并发“缓存雪崩”熔断**: 针对 `v3.2.10` 引入的 Promise Coalescing 机制进行鲁棒性升级。由于原定 TTL 有 500ms 缓存期，如果在前几毫秒服务端抛栈，残余 Promise 将继续堵塞后续访问。新增 `catch` 分支强制清除 `landsFetchPromise` 指针，使得网络卡顿失败后，同批次挂载及下一毫秒新来的调用可以瞬间发起重新拉取，确保核心地块探测零延误。
  2. **双队列“重度饿死”防护**: 在分析令牌桶网关（Token Bucket）的优先分发通道时识别出，若存在异常大批量或循环抛转的“加急任务”（如错误化肥卡循环），极有可能导致普通业务通道（`normalQueue`）被完全雪藏导致好友巡查崩盘停摆。引入 `urgentConsecutiveCount`，**每连续派单执行 `5` 次加急请求后，第 `6` 次强制弹出一单普通任务**，实现类操作系统反馈级的软性公平调度算法。
  3. **数据图大盘换肤埋点**: 由于目前全站依赖原生的 Vue + CSS 绘制卡片和报表，暂未引入 Canvas 绘像器（如 ECharts）。为今后接入高可用数据统计留好后门，在 `web/src/stores/app.ts` `useAppStore` 中抽象出一个基于当前主修色系计算回传的 `themeChartPalette` 调色盘变量，为复杂可视化工程提前铺开红毯。
- **涉及文件**:
  - `core/src/services/farm.js`
  - `core/src/utils/network.js`
  - `web/src/stores/app.ts`

## 2026-03-01 00:50
- **修改类型**: 全局多主题架构与设置推荐系统 (v3.3.1 & v3.3.0)
- **摘要**:
  1. **前端多主题切换 (Themes Pro Max)**: 基于 `ui-ux-pro-max` 美学设计原则重构了前端色彩引擎。通过挂载 CSS Variables 和修改 `uno.config.ts` 中的 `green` 系调色板，提供了 5 套高定质感主题（翠绿、赛博紫、黯金黄、深海蓝、猛男粉），并利用 `useStorage` 组合式函数实现本地无刷新持久化。侧边栏增加了微动画调色器。
  2. **智能控制提示面板 (Tooltip Recommendations)**: 为设置页中所有的 18 个自动化开关注入了自研纯 CSS Tooltip 系统。实现了 `hint` 解释与 `recommend` (on/off/conditional) 标签提示，降低了新用户使用门槛。
- **涉及文件**:
  - `web/src/stores/app.ts`
  - `web/uno.config.ts`
  - `web/src/style.css`
  - `web/src/components/Sidebar.vue`
  - `web/src/components/ui/BaseSwitch.vue`
  - `web/src/views/Settings.vue`

## 2026-03-01 00:00
- **修改类型**: 令牌桶进阶并发限制与网络通讯提效 (v3.2.10 & v3.2.9)
- **摘要**:
  1. **完全体优先列队网关 (Dual Queue)**: 修正了简单的 `unshift` 优先插队导致的 LIFO 逆序错乱问题。物理隔离出了 `urgentQueue` (紧急) 和 `normalQueue` (常规) 两个实体队列，让底层发包永远优先清空紧要流量（防偷抢收），为极限 60秒 提供了发包级屏障。
  2. **并发合并去重缓存 (Promise Coalescing)**: 在 `getAllLandsUrgent` 探测器表面增加一层生命周期为 `500ms` 的短时级探测汇聚，使得同时触发抢收预期的多块土地能够复用同一个侦测 Promise，完全阻断高危的短时内重传泛洪流量。
  3. **死等休眠清理**: 移除了底层令牌桶接管后农场与好友业务层多余的 `sleep` 节流函数调用，让流程提速。
- **涉及文件**:
  - `core/src/utils/network.js`
  - `core/src/services/farm.js`
  - `core/src/services/friend.js`

## 2026-03-01 微信扫码UI与逻辑修复
- *前端*: 修改 AccountModal.vue 将微信和QQ扫描切换按钮调整为并排平铺。在切换请求时重置旧二维码缓存，避免出现UI混淆。
- *后端*: 修改 core/src/controllers/admin.js 确保微信扫码返回的 Base64 统一带有 data:image/png;base64, 前缀。

## 2026-03-01 20:30 近期优化全面复查 (Audit & Hardening)
- **修改类型**: 近期优化质量审计与隐患修复 (v3.5.2)
- **摘要**:
  1. **编辑模式平台同步修复**: 发现并修复 `AccountModal.vue` 在编辑已有账号时，`qrPlatform` 未同步 `editData.platform` 的逻辑缺陷。此 Bug 导致编辑微信账号时仍然默认请求 QQ 二维码，扫码无法完成。
  2. **主题光球背景修复**: 修复 `style.css` 中 mesh 光球背景不可见的 CSS 选择器 Bug。原选择器 `body:not(.theme-default)` 永远无法匹配（因为主题 class 添加在 `<html>` 元素上），已改为 `html[class*="theme-"]`。
  3. **微信 API 超时保护**: 为 `admin.js` 中的三处微信扫码外部 API 调用（`getqr`、`checkqr`、`jslogin`）添加了 AbortController 超时保护（10-15 秒），防止 aineishe.com 服务异常时 fetch 永远挂起导致前端轮询堆积。
  4. **安全隐患剥离**: 正式移除了 `admin.js` 源码中的硬编码服务秘钥，建立起 `CONFIG.wxApiKey` 并实现通过 `.env` 中的环境变量 (`WX_API_KEY`) 进行绝对安全挂载脱敏机制。
  5. **NProgress 主题流体融合**: 将原版 `web/src/style.css` 内粗糙的死绿色顶端进度条彻底废弃。经过重构，当前全应用的 Ajax 加载光带及光晕将全部听命于 `rgb(var(--color-primary-500))` 系统级抽象层动态映射指令！
- **涉及文件**:
  - `web/src/components/AccountModal.vue` (qrPlatform 编辑态同步)
  - `web/src/style.css` (mesh-bg 及 nprogress 选择器修正)
  - `core/src/controllers/admin.js` (fetch 探针守护防御与 API Key 脱离)
  - `core/src/config/config.js` (环境变量映射层建立)
  - `.env` (密钥源)

## 2026-03-01 23:30 系统架构进阶计划 (Phase 4 - Cloud Sync & Chunking)
- **修改类型**: 端云仲裁与组件级懒加载性能优化 (v3.6.0)
- **摘要**:
  1. **端云极速仲裁机制 (State Hash Arbitration)**: 彻底解决了由于多端页面重载或切换导致 `app.ts` 持久化设定的历史配置（主题/面板/性能模式）覆盖当前活跃数据。针对本地化与云端保存挂载了 `uiTimestamp`，形成时间戳防伪比对墙；当发现服务器云端存在的数据更陈旧时，前端有权强制打回覆盖，实现全量多开配置无冲突合流。
  2. **异步弹窗代码切片 (Async Component Layering)**: 为解决打包文件无限制增加而拖慢首屏，重构了 `web/src/App.vue` 核心。使用 `defineAsyncComponent` 将重量级的 `NotificationModal` 与 `ToastContainer` 从初次捆绑解析树剥离。经过测试，通知弹窗目前已经顺利切割为独立 `.js.gz` 碎片，极大化保护主应用的响应加载 (TTFB)。
- **涉及文件**:
  - `web/src/stores/app.ts` (增加 uiTimestamp 防刷)
  - `core/src/controllers/admin.js` (UI 接收/广播增加 timestamp 槽)
  - `core/src/models/store.js` (存入本地存储前的拦截融合)
  - `web/src/App.vue` (引入按需懒加载)

## 2026-03-02 数据引擎迁移大决战
- **时间**: 2026-03-02
- **类型**: 架构重构 / 性能隔离
- **摘要**: 【猛药根绝】完全废除 `accounts.json` 和 `store.js` 内部的同步文件 IO。从 `client.js` 到各种后台作业 `logCleanupJob` 以及 `admin.js` 路由，全量挂载 Async / Await MySQL Pool 操作，加入 Redis 兜底缓存机制，根除了由于并发和架构欠债造成的卡顿、数据越权混用现象。彻底解决了数据隔离问题。
- **涉及文件**: `models/store.js`, `runtime/data-provider.js`, `controllers/admin.js`, `services/database.js`, `client.js`, `jobs/*` 等数十个核心模块。

